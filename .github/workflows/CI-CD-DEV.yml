# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Nextjs CI cd docker

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
  
  workflow_dispatch:
    inputs:
      targetEnv:
        description: 'Target ENV i.e: develop, main'
        required: true
        default: 'develop'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    name: Docker Build Image
    steps:
    - uses: actions/checkout@v3
    - name: Set up Node 20
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
        cache-dependency-path: package-lock.json
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }}
    # ------------------ START APP ENVIRONMENT SELECTOR FROM PARAM SECTION ----------
    #Check selected ENV
    - name: Check ENV params
      run: echo targetEnv param is ${{ github.event.inputs.targetEnv }}

    #Check if ENV param is empty due to PR trigger then use QA as default
    - name: Check if Param ENV is incorrect . If so then select QA as default
      if: ${{ github.event.inputs.targetEnv == '' }}
      run: echo "TARGET_ENV=develop" >> "$GITHUB_ENV"
    #-------------------------- Build -------------------
    - name: Check TARGET ENV  param
      run: echo "${{ env.TARGET_ENV }}"
    - name: Install depenencies
      run: npm install
    - name: Create and populate .env.local file
      env:
        NEXT_PUBLIC_2CAPTCHA_API_KEY: ${{ secrets.CAPTCHA_API_KEY }}
      run: |
        touch .env.local
        echo "cat .env.local"
        cat .env.local

        echo "ls -a ."
        ls -a .

        echo "ls -a ${{ github.workspace }}"
        ls -a ${{ github.workspace }}
      shell: bash
    - name: Build with npm
      run: npm run build
    #-------------------------- Build Docker images and push -------------------
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    - name: Build and push docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        tags: douglascamposh/sicoesweb
        push: true

